# Sequence: File Retrieval with Fallback

**Source Spec:** main.md - getFile(cid, fallbackPeerID?) (lines 437-471)

**Participants:**
- Client A: P2PWebAppClient instance
- WebSocketHandler: Routes file retrieval requests to Peer via PeerManager
- PeerManager: Returns Peer instance by peerID and provides callbacks
- Local Peer: The peer associated with Client A (requests file from IPFS or fallback peer)
- Fallback Peer: Optional peer that may have the file if not found locally
- IPFS Network: Distributed file storage network

**Flow:**

This sequence demonstrates file retrieval with an optional fallback mechanism. The client requests a file by CID, optionally specifying a fallback peer. If the file exists in the local IPFS node, it's retrieved immediately. If not found locally and a fallback peer is specified, the reserved "p2p-webapp" libp2p protocol is used to request the file from the fallback peer using `getFile(cid)` (type 2) and `fileContent(...)` (type 3) messages. The retrieved file is automatically added to the local IPFS node. The server sends `gotFile(cid, {success, content})` to the client to resolve or reject the promise.

```
                              ┌────────┐                                           ┌────────────────┐             ┌───────────┐                                         ┌───────────┐           ┌─────────┐           ┌─────────────┐
                              │Client A│                                           │WebSocketHandler│             │PeerManager│                                         │Local Peer │           │IPFS Node│           │Fallback Peer│
                              └────┬───┘                                           └────────┬───────┘             └─────┬─────┘                                         └─────┬─────┘           └────┬────┘           └──────┬──────┘
                                   │                                                        │                           │                                                     │                      │                       │
                                   │                                                        │                       ╔═══╧══════════╗                                          │                      │                       │
═══════════════════════════════════╪════════════════════════════════════════════════════════╪═══════════════════════╣ Get File   ╠══════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════════
                                   │                                                        │                       ╚═══╤══════════╝                                          │                      │                       │
                                   │                                                        │                           │                                                     │                      │                       │
                                   │────┐                                                   │                           │                                                     │                      │                       │
                                   │    │ getFile(cid, fallbackPeerID?)                     │                           │                                                     │                      │                       │
                                   │<───┘                                                   │                           │                                                     │                      │                       │
                                   │                                                        │                           │                                                     │                      │                       │
                                   │────┐                                                   │                           │                                                     │                      │                       │
                                   │    │ Check getFilePending[cid]                         │                           │                                                     │                      │                       │
                                   │<───┘                                                   │                           │                                                     │                      │                       │
                                   │                                                        │                           │                                                     │                      │                       │
                                   │                                                        │                           │                                                     │                      │                       │
          ╔══════╤═════════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════════╗
          ║ ALT  │  No existing pending request for cid                                     │                           │                                                     │                      │                       │                                       ║
          ╟──────┘                 │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │────┐                                                   │                           │                                                     │                      │                       │                                       ║
          ║                        │    │ Create promise, store in getFilePending[cid]      │                           │                                                     │                      │                       │                                       ║
          ║                        │<───┘                                                   │                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │            getFile(cid, fallbackPeerID)                │                           │                                                     │                      │                       │                                       ║
          ║                        │───────────────────────────────────────────────────────>│                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │    getPeer(peerID)        │                                                     │                      │                       │                                       ║
          ║                        │                                                        │──────────────────────────>│                                                     │                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │      peer instance        │                                                     │                      │                       │                                       ║
          ║                        │                                                        │<──────────────────────────│                                                     │                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │getFile(cid, fallbackPeerID)│                                                    │                      │                       │                                       ║
          ║                        │                                                        │──────────────────────────────────────────────────────────────────────────────────>│                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │──────────────────────>│                       │                                       ║
          ║                        │                                                        │                           │                                                     │  ipfsPeer.Get(cid)   │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ║         ╔══════╤═══════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════╗   ║
          ║         ║ ALT  │  File found in local IPFS node                                 │                           │                                                     │                      │                       │                                   ║   ║
          ║         ╟──────┘       │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<─────────────────────│                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │  node data           │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │────┐                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │    │ Extract content, detect MIME type         │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<───┘                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │────┐                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │    │ Spawn goroutine  │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<───┘                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                       gotFile(cid, {success: true, content})│                       │                                   ║   ║
          ║         ║              │                                                        │                           │<────────────────────────────────────────────────────│                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │      gotFile(cid, {success: true, content})            │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │<───────────────────────────────────────────────────────│                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │────┐                                                   │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │    │ Resolve promise with FileContent                  │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │<───┘                                                   │                           │                                                     │                      │                       │                                   ║   ║
          ║         ╠══════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════╣   ║
          ║         ║ [File NOT found in local IPFS and fallbackPeerID provided]            │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<─────────────────────│                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │  error (not found)   │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │────┐                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │    │ Store error for later│                  │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<───┘                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                            send("p2p-webapp", getFile(cid)) │                                   ║   ║
          ║         ║              │                                                        │                           │                                            ─────────────────────────────────>│                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │────┐                              ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │    │ handleGetFile(cid)          ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │<───┘                              ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │────┐                              ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │    │ ipfsPeer.Get(cid)           ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │<───┘                              ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │────┐                              ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │    │ Extract content, MIME type  ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │<───┘                              ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                            send("p2p-webapp", fileContent(cid, content, mimeType)) │                  ║   ║
          ║         ║              │                                                        │                           │                                            <─────────────────────────────────│                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │────┐                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │    │ handleFileContent(cid, content, mimeType)│                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<───┘                 │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │──────────────────────>│                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │  ipfsPeer.Add(content)│                      │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<─────────────────────│                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │  success             │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                       gotFile(cid, {success: true, content})│                       │                                   ║   ║
          ║         ║              │                                                        │                           │<────────────────────────────────────────────────────│                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │      gotFile(cid, {success: true, content})            │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │<───────────────────────────────────────────────────────│                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │────┐                                                   │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │    │ Resolve promise with FileContent                  │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │<───┘                                                   │                           │                                                     │                      │                       │                                   ║   ║
          ║         ╠══════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════╣   ║
          ║         ║ [File NOT found in local IPFS and NO fallbackPeerID provided]         │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │<─────────────────────│                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │  error (not found)   │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                       gotFile(cid, {success: false, error})│                       │                                   ║   ║
          ║         ║              │                                                        │                           │<────────────────────────────────────────────────────│                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │      gotFile(cid, {success: false, error})             │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │<───────────────────────────────────────────────────────│                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │                                                        │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │────┐                                                   │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │    │ Reject promise with error                         │                           │                                                     │                      │                       │                                   ║   ║
          ║         ║              │<───┘                                                   │                           │                                                     │                      │                       │                                   ║   ║
          ║         ╚══════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════╝   ║
          ║                        │                                                        │                           │                                                     │                      │                       │                                       ║
          ╠════════════════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════════╣
          ║ [Existing pending request for cid - reuse existing promise]                    │                           │                                                     │                      │                       │                                       ║
          ║                        │────┐                                                   │                           │                                                     │                      │                       │                                       ║
          ║                        │    │ Return existing promise from getFilePending[cid]  │                           │                                                     │                      │                       │                                       ║
          ║                        │<───┘                                                   │                           │                                                     │                      │                       │                                       ║
          ╚════════════════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════════╝
═══════════════════════════════════╪════════════════════════════════════════════════════════╪═══════════════════════════╪═════════════════════════════════════════════════════╪══════════════════════╪═══════════════════════╪═══════════════════════════════════════
                                   │                                                        │                           │                                                     │                      │                       │
```

## Notes

- **Request Deduplication**: If multiple clients request the same CID simultaneously, only one IPFS request is made. All pending promises for that CID are resolved when the response arrives.
- **Fallback Mechanism**: The fallback peer is only contacted if the file is not found in the local IPFS node. This ensures efficient use of network resources.
- **Automatic IPFS Caching**: When a file or directory is retrieved from a fallback peer:
  - The raw IPFS node data is transmitted in the response (`rawNode` field)
  - The node is added to the local IPFS blockstore using `blocks.NewBlockWithCid()` and `blockstore.Put()`
  - This makes the node available for subsequent requests from other peers
  - Both files and directories are cached completely, enabling full IPFS node sharing
- **Error Handling**: If the fallback peer doesn't have the file or an error occurs during retrieval, the original "not found" error is returned to the client.
- **Protocol Messages**: Uses the reserved "p2p-webapp" protocol with message types:
  - Type 2: `getFile(cid)` - Request file from peer
  - Type 3: `fileContent(cid, rawNode, content, mimeType, ...)` - Send file content and raw node data to requesting peer

# Test Design: PeerManager

**Source Specs**: main.md
**CRC Cards**: crc-PeerManager.md, crc-Peer.md
**Sequences**: seq-peer-creation.md, seq-add-peers.md, seq-remove-peers.md

## Overview

Test suite for PeerManager component covering peer lifecycle, discovery configuration, callback management, and alias generation.

## Test Cases

### Test: Create peer with fresh key

**Purpose**: Verify that PeerManager creates a new peer with a freshly generated key when no key is provided.

**Motivation**: Core peer creation happy path. Ensures new peers can be created with unique identities.

**Input**:
- PeerManager instance
- Call createPeer(nil) with no peer key

**References**:
- CRC: crc-PeerManager.md - "Does: createPeer"
- Sequence: seq-peer-creation.md

**Expected Results**:
- New Peer instance created
- Fresh peer key generated by libp2p
- Peer assigned unique peerID
- Peer stored in PeerManager.peers map
- Human-readable alias generated (e.g., "peer-a")
- Alias stored in peerAliases map
- Discovery enabled (mDNS + DHT)
- NAT traversal configured (Circuit Relay, hole punching, AutoRelay, UPnP)

**References**:
- CRC: crc-PeerManager.md - "Knows: peers"
- CRC: crc-PeerManager.md - "Knows: peerAliases"
- CRC: crc-PeerManager.md - "Does: getOrCreateAlias"
- CRC: crc-PeerManager.md - "Does: enableDiscovery"
- CRC: crc-PeerManager.md - "Does: enableNATTraversal"

---

### Test: Create peer with provided key

**Purpose**: Verify that PeerManager creates a peer using a provided peer key, enabling identity persistence.

**Motivation**: Enables users to maintain same peer identity across sessions.

**Input**:
- PeerManager instance
- Valid peer key from previous session
- Call createPeer(existingKey)

**References**:
- CRC: crc-PeerManager.md - "Does: createPeer"
- Sequence: seq-peer-creation.md

**Expected Results**:
- New Peer instance created
- Peer uses provided key (not generated)
- PeerID derived from provided key
- Peer stored in peers map
- Alias generated for this peerID
- Discovery and NAT traversal configured

**References**:
- CRC: crc-PeerManager.md - "Knows: peers"
- CRC: crc-PeerManager.md - "Does: createPeer"

---

### Test: Create peer with duplicate peerID

**Purpose**: Verify that PeerManager rejects creation of peer when peerID already exists.

**Motivation**: Prevents multiple tabs/clients using same peer identity which would cause conflicts.

**Input**:
- PeerManager instance with existing peer (peerID: "12D3KooW...")
- Attempt to create another peer with same peer key

**References**:
- CRC: crc-PeerManager.md - "Does: createPeer"
- Sequence: seq-peer-creation.md

**Expected Results**:
- createPeer() returns error indicating duplicate peerID
- No new peer added to peers map
- Original peer remains unchanged
- No alias generated for failed creation

**References**:
- CRC: crc-PeerManager.md - "Knows: peers"

---

### Test: Create peer with root directory CID

**Purpose**: Verify that PeerManager can restore peer state from a root directory CID.

**Motivation**: Enables persistence of peer's file storage state across sessions.

**Input**:
- PeerManager instance
- Valid peer key
- Valid root directory CID from previous session
- Call createPeer(peerKey, rootCID)

**References**:
- CRC: crc-PeerManager.md - "Does: createPeer"

**Expected Results**:
- New Peer instance created
- Peer initialized with provided peer key
- Peer's HAMTDirectory restored from root CID
- Directory contents accessible via listFiles()
- Discovery and NAT traversal configured

**References**:
- CRC: crc-PeerManager.md - "Does: createPeer"
- CRC: crc-Peer.md - "Knows: directory, directoryCID"

---

### Test: Remove peer and cleanup resources

**Purpose**: Verify that PeerManager properly removes peer and cleans up all associated resources.

**Motivation**: Prevents resource leaks and ensures clean peer lifecycle management.

**Input**:
- PeerManager instance with active peer
- Peer has active connections and subscriptions
- Call removePeer(peerID)

**References**:
- CRC: crc-PeerManager.md - "Does: removePeer"

**Expected Results**:
- Peer removed from peers map
- Alias removed from peerAliases map
- Peer.stop() called to clean up libp2p resources
- All peer connections closed
- All topic subscriptions cancelled
- Peer no longer accessible via getPeer()

**References**:
- CRC: crc-PeerManager.md - "Knows: peers, peerAliases"
- CRC: crc-PeerManager.md - "Collaborators: Peer"

---

### Test: Get existing peer by ID

**Purpose**: Verify that PeerManager returns correct peer instance by peerID.

**Motivation**: Core lookup operation used throughout system.

**Input**:
- PeerManager instance with peers:
  - Peer A: peerID "12D3KooWABC..."
  - Peer B: peerID "12D3KooWXYZ..."
- Call getPeer("12D3KooWABC...")

**References**:
- CRC: crc-PeerManager.md - "Does: getPeer"

**Expected Results**:
- Returns Peer A instance
- Returned peer has correct peerID
- No error

**References**:
- CRC: crc-PeerManager.md - "Knows: peers"

---

### Test: Get nonexistent peer

**Purpose**: Verify that PeerManager handles lookup of nonexistent peer gracefully.

**Motivation**: Edge case for invalid peerID or race conditions.

**Input**:
- PeerManager instance with some peers
- Call getPeer("12D3KooWNONEXISTENT...")

**References**:
- CRC: crc-PeerManager.md - "Does: getPeer"

**Expected Results**:
- Returns nil or error indicating peer not found
- No crash or panic
- No side effects

**References**:
- CRC: crc-PeerManager.md - "Knows: peers"

---

### Test: Add peers to connection protection

**Purpose**: Verify that PeerManager coordinates peer connection protection and tagging.

**Motivation**: Ensures important peer connections persist and aren't pruned.

**Input**:
- PeerManager instance with Peer A
- List of peer IDs to protect: ["12D3KooWFriend1...", "12D3KooWFriend2..."]
- Call addPeers(peerID_A, peerIDsToProtect)

**References**:
- CRC: crc-PeerManager.md - "Does: addPeers"
- CRC: crc-Peer.md - "Does: addPeers"
- Sequence: seq-add-peers.md

**Expected Results**:
- PeerManager calls getPeer(peerID_A) to get Peer A
- PeerManager calls peer.AddPeers(peerIDsToProtect)
- Peer A protects connections using ConnManager().Protect() with "connected" tag
- Peer A tags connections using TagPeer() with tag="connected", value=100
- Peer A attempts connection if not already connected
- Protected peers persist even under connection pressure

**References**:
- CRC: crc-PeerManager.md - "Collaborators: Peer"
- CRC: crc-Peer.md - "Does: addPeers"

---

### Test: Remove peers from connection protection

**Purpose**: Verify that PeerManager coordinates peer connection unprotection and untagging.

**Motivation**: Allows connection manager to prune unneeded connections.

**Input**:
- PeerManager instance with Peer A
- Peer A has protected connections to ["12D3KooWFriend1...", "12D3KooWFriend2..."]
- Call removePeers(peerID_A, ["12D3KooWFriend1..."])

**References**:
- CRC: crc-PeerManager.md - "Does: removePeers"
- CRC: crc-Peer.md - "Does: removePeers"
- Sequence: seq-remove-peers.md

**Expected Results**:
- PeerManager calls peer.RemovePeers() on Peer A
- Peer A unprotects connection using ConnManager().Unprotect() with "connected" tag
- Peer A untags connection using UntagPeer() with "connected" tag
- Connection eligible for pruning by connection manager
- Friend2 remains protected

**References**:
- CRC: crc-PeerManager.md - "Collaborators: Peer"
- CRC: crc-Peer.md - "Does: removePeers"

---

### Test: Enable mDNS and DHT discovery

**Purpose**: Verify that PeerManager configures both local (mDNS) and global (DHT) peer discovery.

**Motivation**: Core functionality for peer-to-peer networking. Must work for both LAN and WAN.

**Input**:
- PeerManager instance
- Newly created peer
- Call enableDiscovery(peer)

**References**:
- CRC: crc-PeerManager.md - "Does: enableDiscovery"

**Expected Results**:
- mDNS service initialized for local peer discovery
- DHT service initialized for global peer discovery
- Peer advertises itself on both services
- Peer can discover other peers via mDNS (LAN)
- Peer can discover other peers via DHT (WAN)

**References**:
- CRC: crc-PeerManager.md - "Does: enableDiscovery"
- CRC: crc-Peer.md - "Knows: mdnsService, dht"

---

### Test: Enable NAT traversal

**Purpose**: Verify that PeerManager configures all NAT traversal mechanisms.

**Motivation**: Ensures peers behind NAT/firewall can establish connections.

**Input**:
- PeerManager instance
- Newly created peer behind NAT
- Call enableNATTraversal(peer)

**References**:
- CRC: crc-PeerManager.md - "Does: enableNATTraversal"

**Expected Results**:
- Circuit Relay v2 configured (can relay through other peers)
- Hole punching configured (Direct Connection Upgrade)
- AutoRelay configured (automatic relay selection)
- UPnP port mapping configured (automatic port forwarding)
- Peer can establish connections despite NAT

**References**:
- CRC: crc-PeerManager.md - "Does: enableNATTraversal"

---

### Test: Set callbacks for peer events

**Purpose**: Verify that PeerManager stores callback functions and provides them to peers.

**Motivation**: Enables event-driven architecture for protocol and topic messages.

**Input**:
- PeerManager instance
- Callback functions:
  - onPeerData: func(peerID, protocol, data)
  - onTopicData: func(peerID, topic, data)
  - onPeerChange: func(topic, peerID, joined)
  - onPeerFiles: func(peerID, rootCID, entries)
  - onGotFile: func(success, content)

**References**:
- CRC: crc-PeerManager.md - "Does: setCallbacks"
- CRC: crc-PeerManager.md - "Knows: onPeerData, onTopicData, onPeerChange, onPeerFiles, onGotFile"

**Expected Results**:
- All callback functions stored in PeerManager
- Callbacks provided to peers when created
- Peers invoke callbacks on appropriate events
- Callbacks receive correct parameters

**References**:
- CRC: crc-PeerManager.md - "Collaborators: Peer"

---

### Test: Generate unique aliases

**Purpose**: Verify that PeerManager generates sequential human-readable aliases for peers.

**Motivation**: Enables easier log reading and debugging with readable peer identifiers.

**Input**:
- PeerManager instance with aliasCounter = 0
- Create three peers sequentially

**References**:
- CRC: crc-PeerManager.md - "Does: getOrCreateAlias"
- CRC: crc-PeerManager.md - "Knows: aliasCounter, peerAliases"

**Expected Results**:
- First peer: alias = "peer-a", aliasCounter = 1
- Second peer: alias = "peer-b", aliasCounter = 2
- Third peer: alias = "peer-c", aliasCounter = 3
- Each alias unique and stored in peerAliases map
- Calling getOrCreateAlias() again for same peerID returns existing alias

**References**:
- CRC: crc-PeerManager.md - "Knows: peerAliases, aliasCounter"

---

### Test: Verbose logging with peer aliases

**Purpose**: Verify that PeerManager prefixes log messages with peer aliases.

**Motivation**: Makes logs more readable when managing multiple peers.

**Input**:
- PeerManager instance with verbosity = 2
- Peer with alias "peer-a"
- Various operations that generate logs

**References**:
- CRC: crc-PeerManager.md - "Does: logVerbose"
- CRC: crc-PeerManager.md - "Knows: verbosity"

**Expected Results**:
- Log messages include peer alias prefix: "[peer-a] message text"
- Messages only logged if verbosity level appropriate
- Verbosity level 0: no logs
- Verbosity level 1+: increasing detail

**References**:
- CRC: crc-PeerManager.md - "Does: logVerbose"
- CRC: crc-PeerManager.md - "Knows: peerAliases"

---

### Test: File update notification configuration

**Purpose**: Verify that PeerManager configures peers with optional file update notification topic.

**Motivation**: Enables automatic UI refresh when peer files change.

**Input**:
- Test 1: PeerManager with fileUpdateNotifyTopic = "file-updates"
- Test 2: PeerManager with fileUpdateNotifyTopic = "" (empty, disabled)

**References**:
- CRC: crc-PeerManager.md - "Knows: fileUpdateNotifyTopic"

**Expected Results**:
- Test 1: Peers receive "file-updates" topic configuration
- Test 1: Peers publish notifications on storeFile/removeFile when subscribed
- Test 2: Peers do not publish file update notifications
- Configuration loaded from P2PConfig in config file

**References**:
- CRC: crc-PeerManager.md - "Knows: fileUpdateNotifyTopic"
- CRC: crc-Peer.md - "Does: publishFileUpdateNotification"

## Coverage Summary

**Responsibilities Covered**:
- ✅ createPeer - Fresh key, provided key, duplicate, rootCID tests
- ✅ removePeer - Resource cleanup test
- ✅ getPeer - Existing and nonexistent peer tests
- ✅ addPeers - Connection protection coordination test
- ✅ removePeers - Connection unprotection coordination test
- ✅ enableDiscovery - mDNS + DHT configuration test
- ✅ enableNATTraversal - Circuit Relay, hole punching, AutoRelay, UPnP test
- ✅ setCallbacks - Callback storage and provision test
- ✅ logVerbose - Alias-prefixed logging test
- ✅ getOrCreateAlias - Sequential alias generation test
- ✅ All "Knows" properties - Covered through various tests

**Scenarios Covered**:
- ✅ seq-peer-creation.md - Fresh key, provided key, duplicate tests
- ✅ seq-add-peers.md - Connection protection test
- ✅ seq-remove-peers.md - Connection unprotection test

**Gaps**:
- Concurrent peer creation/removal not tested (future enhancement)
- Discovery integration with actual network not tested (requires integration test environment)
- NAT traversal with real NAT devices not tested (requires integration test environment)
